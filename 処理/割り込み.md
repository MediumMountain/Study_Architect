# 割り込み処理

## 分類
- ハードウェア割り込み
    - 外部割り込み
    - 内部割り込み

- ソフトウェア割り込み



### 外部割り込み【external interrupt】ハードウェア割り込み / hardware interrupt
- 実行中の処理を中断して強制的に指定された処理を実行させる割り込み処理の種類の一つで、実行中のプログラム以外の外部の要因によって発生したもの。
- ハードウェアによる処理要求により引き起こされるためハードウェア割り込みとも呼ばれる。
- 主に入出力装置やタイマーなどが処理を要求するため発生するもので、利用者がキーボードを操作したり、ネットワークを通じて外部からデータを受信したり、外部記憶装置がデータの読み書きを終えたりすると発生する。



### 内部割り込み【internal interrupt】ソフトウェア割り込み / software interrupt
- 実行中の処理を中断して強制的に指定された処理を実行させる割り込み処理の一つで、実行中のプログラム自身に起因するもの。
- ハードウェアが引き起こすものと対比してソフトウェア割り込みとも呼ばれる。
- 実行中のプログラムがゼロ除算を行ったり、書き込みが禁止されたメモリ領域へ書き込もうとするなど、何らかのエラーや例外（exception）が起きると、これを処理するために割り込みが発生する。
- また、OSの機能を呼び出す際にCPUの実行モードを切り替えるなどの目的で、プログラム自身が割り込み命令を実行してあえて発生させる場合もあり、「SVC割り込み」（スーパーバイザコール割り込み）などと呼ばれることもある。



### 割り込みコントローラ (interrupt controller)
- コンピュータ内部の制御回路の一つで、周辺機器とCPUの間に接続され、周辺機器からの割り込み処理要求を受信してCPUに割り込み信号を発生させる装置。
- 周辺機器に対する窓口を担うCPUの秘書のような存在で、単体のICチップではなくチップセットなどの一部として実装されることが多い。

- 周辺機器はボタンを利用者に押されるなど何らかの処理を行いたくなると、それをCPUに伝えるために割り込み信号を発信する。
- 割り込みコントローラがコンピュータ内に存在する場合、この信号はいったんコントローラに集められる。

- コントローラは装置ごとに設定されている優先度などに基づいてどのタイミングでどの信号をCPUに伝えるかを判断し、適切な順序で信号を伝える。
- また、無効に設定されている機器からの信号を無視してCPUに伝えないといった処理も行う。


### 割り込みレベル
- 複数のタスクを同時に効率よく処理するために割り込みにはレベルを割り振られている。



## 割り込み処理を扱う際の注意点
- オーバーヘッド
    - 割り込み処理を行う時には、その準備処理や割り込み処理終了後の処理でも多少の時間が必要になる。
    - また、状態を保存するための領域も必要となるため、あらかじめ考慮しておく。

- 共通リソースの操作
    - １つの変数、レジスタ、ＣＰＵ出力ポート、ＩＣなど
    - 通常の処理と割り込み処理とで操作するリソースを分けるのが理想


## マスカブル割り込み
- CPUに対するハードウェア割り込みのうち、一時的に抑止できるもの。通常時の機器の制御などに用いられる。
- CPUに対して専用の制御命令を発することで、割り込みの許可（enable）と禁止（disable）を切り替えることができる。

- 途中で割り込みが起こると不都合な処理を行う際にCPUに割り込みの禁止を指示し、そのような処理が終わったら再び割り込みを許可するという使い方ができる。
- 割り込み禁止中に生じた割り込み要求は待機状態に置かれ、再び許可されると割り込み処理が発生する。

- 一方、割り込みの発生を抑止できず、常に強制的に割り込みが行われるようなハードウェア割り込みもあり、「ノンマスカブル割り込み」（NMI：Non-Maskable Interrupt）と呼ばれる。障害発生時など緊急に対応する必要がある場合などに用いられる。


## ノンマスカブル割り込み【NMI】Non-Maskable Interrupt / マスク不可割り込み
- CPUに対するハードウェア割り込みのうち、禁止できないもの。ハードウェアに障害発生した場合など、緊急時や特殊な場合に用いられることが多い。
- 機種によって詳細は異なるが、ハードウェアに緊急で致命的な問題が生じた場合に、これに対処する処理を行うために用いられる。
- 割り込みの中では最上位の優先度が与えられ、割り込み処理の実行中は他の割り込みを受け付けない設計になっていることが多い。



### MSI（Message Signaled Interrupts）


### ISR 【Interrupt Service Routine】 / 割り込みハンドラ【interrupt handler】割り込みサービスルーチン
- オペレーティングシステム（OS）内のプログラムの一部で、割り込みが発生したときに起動され、対応する処理を行うもの。
- メモリ上に常駐しており、割り込みの種類ごとに用意される。

- コンピュータのCPUやOSには、周辺機器から処理要求を受信するなど何らかの事象が発生した際に、実行中のプログラムを強制的に一時停止し、要求に対応する処理を行う「割り込み」（interrupt：インタラプト）と呼ばれる仕組みが存在する。

- OSは割り込みが発生すると、イベントの種類に応じてあらかじめ登録された割り込みハンドラの中から一つを選んで呼び出し、処理を行わせる。
- $WODRDによる処理が終わると、割り込まれたプログラムの実行が再開される。



## ポーリング割込み処理
- 複数の機器やソフトウェアを円滑に連携させる制御方式の一つで、主となるシステムが他のシステムに対して一定間隔で順繰りに要求がないか尋ねる方式。
- コンピュータと周辺機器が一つの通信路で繋がっている場合のように、複数のシステムが独立に動作して主システムと通信しているような状況では、各システムが自らのタイミングで通信を行うと処理や信号が他のシステムと競合して不具合を生じる場合がある。
    - このような場合、主システムが一定時間ごとにポーリングを行い、各システムは問い合わせのあったときのみ要求を伝えるようにすることで、整然と通信することができる。

- また、WebサーバとWebブラウザの関係のように、片方に相手方へ能動的に要求を伝達する仕組みがない非対称な状況でも、能動側から定期的に問い合わせを行い、受動側に要求があるときはその返答として情報を伝達することで、擬似的に双方向的なやり取りを行うことができるようになる。


### volatile

### ice (in cirsuit emu)

## ベクタ方式による割込み処理
- 多くの割込み源がある場合に適切にその信号源を特定し適切な割込みサービスをするためのひとつにベクタ方式がある．
- ベクタとはその 1 成分がある装置の割込み処理ルーチン（ISR）のアドレスになるということからくる．
- 割込み源にある装置は CPU からの受付け信号（INTA）を受け取ったら ISR のアドレスをバスのデータラインにロードし CPU はどの割込みかを識別する．
- しかしこのやり方は Sequence Controller の設計を複雑にする．

- もうひとつの方法は図 2 のような１つの IRQ 受付けではなく多重の IRQ 信号を受付けつけられるように CPU に IRQ 用入力 pin を多数用意することである．
- このためにはどこかに（通常メモリの一部に）それぞれに対応した信号を保持しておかなければならない．
- メモリ領域がそのために費やされてしまうという欠点はあるが割込み処理ハードウェアデザインの簡易化と処理時間の短縮化が大幅にはかられることになる．


### INTA




## 多重割込み
### 割込み処理の入れ子
### 同時割込み



### マイコンでの割り込み処理
- 割り込みはマイコン内部と外部のさまざまな機器から発生する。
- スイッチやセンサなどマイコン外部からの割り込みは外部端子割り込みと呼ばれ、それらの機器からの割り込み信号をIRQというピンで受信し、割り込みコントローラに通知する。

- マイコン内部にあるタイマやGPIO、シリアル通信デバイスUARTなどの周辺機器からの割り込みは周辺機器割り込みと呼ばれ割り込み信号は各々の周辺機器から直接、割り込みコントローラに通知する。


### IRQ【Interrupt Request】
- コンピュータ内部の装置や周辺機器などが中央処理装置（CPU）に信号を送り、現在の処理を中断して強制的に指定した処理を実行するよう要求すること。「割り込み要求」


### PC(Program Counter)

### PS() : ステータスレジスタ


## 例外処理【exception handling】
- プログラムの実行の継続を妨げる異常な事象（「例外」と呼ばれる）が発生した際に、その内容に応じて実行される処理のこと。
- 多くの言語で用意されている例外処理のための記法（try～catch文など）では、ある範囲（ブロックなど）のコードの実行中に例外が生じたときの処理内容を、その範囲の末尾に記述する。
    - 例外が起きなければその部分は飛ばされて実行されない。

- 関数のように引数として例外についての情報を処理系から受け取ることができるようになっていることが多く、例外の種類ごとに異なる処理を記述したり、付随する実行状態についてのデータなどを処理内容に反映させることができる。
- 例外処理が用意されていない例外や、対応が困難な致命的な例外が発生すると、エラーメッセージが表示されてプログラムが異常終了し、OSの操作画面に戻る場合が多い。




### アセンブラ展開


### REFERENCE
ルネサス
https://www.renesas.com/jp/ja/support/engineer-school/mcu-programming-peripherals-04-interrupts

https://www.renesas.com/us/ja/document/man/897151


メインフレームコンピュータ
http://www.arteceed.net/6.html
https://arteceed.info/


東芝デバイス＆ストレージ_e-ラーニング
https://toshiba.semicon-storage.com/jp/semiconductor/knowledge/e-learning.html

割り込みハードウェアメカニズム
https://www.comp.tmu.ac.jp/morbier/work/interrupthwmec.pdf


割り込みについて
https://qiita.com/timwata/items/8dea85c33871a3e836ec
