# 割り込み処理

## 分類
- ハードウェア割り込み
    - 外部割り込み
    - 内部割り込み

- ソフトウェア割り込み


### 割り込みレベル
- 複数のタスクを同時に効率よく処理するために割り込みにはレベルを割り振られている。



## 割り込み処理を扱う際の注意点
- オーバーヘッド
    - 割り込み処理を行う時には、その準備処理や割り込み処理終了後の処理でも多少の時間が必要になる。
    - また、状態を保存するための領域も必要となるため、あらかじめ考慮しておく。

- 共通リソースの操作
    - １つの変数、レジスタ、ＣＰＵ出力ポート、ＩＣなど
    - 通常の処理と割り込み処理とで操作するリソースを分けるのが理想


## マスカブル割り込み
- CPUに対するハードウェア割り込みのうち、一時的に抑止できるもの。通常時の機器の制御などに用いられる。
- CPUに対して専用の制御命令を発することで、割り込みの許可（enable）と禁止（disable）を切り替えることができる。

- 途中で割り込みが起こると不都合な処理を行う際にCPUに割り込みの禁止を指示し、そのような処理が終わったら再び割り込みを許可するという使い方ができる。
- 割り込み禁止中に生じた割り込み要求は待機状態に置かれ、再び許可されると割り込み処理が発生する。

- 一方、割り込みの発生を抑止できず、常に強制的に割り込みが行われるようなハードウェア割り込みもあり、「ノンマスカブル割り込み」（NMI：Non-Maskable Interrupt）と呼ばれる。障害発生時など緊急に対応する必要がある場合などに用いられる。


## ノンマスカブル割り込み【NMI】Non-Maskable Interrupt / マスク不可割り込み
- CPUに対するハードウェア割り込みのうち、禁止できないもの。ハードウェアに障害発生した場合など、緊急時や特殊な場合に用いられることが多い。
- 機種によって詳細は異なるが、ハードウェアに緊急で致命的な問題が生じた場合に、これに対処する処理を行うために用いられる。
- 割り込みの中では最上位の優先度が与えられ、割り込み処理の実行中は他の割り込みを受け付けない設計になっていることが多い。


### IRQ
### ISR



## ポーリング割込み処理


## ベクタ方式による割込み処理
- 多くの割込み源がある場合に適切にその信号源を特定し適切な割込みサービスをするためのひとつにベクタ方式がある．
- ベクタとはその 1 成分がある装置の割込み処理ルーチン（ISR）のアドレスになるということからくる．
- 割込み源にある装置は CPU からの受付け信号（INTA）を受け取ったら ISR のアドレスをバスのデータラインにロードし CPU はどの割込みかを識別する．
- しかしこのやり方は Sequence Controller の設計を複雑にする．

- もうひとつの方法は図 2 のような１つの IRQ 受付けではなく多重の IRQ 信号を受付けつけられるように CPU に IRQ 用入力 pin を多数用意することである．
- このためにはどこかに（通常メモリの一部に）それぞれに対応した信号を保持しておかなければならない．
- メモリ領域がそのために費やされてしまうという欠点はあるが割込み処理ハードウェアデザインの簡易化と処理時間の短縮化が大幅にはかられることになる．


### INTA




## 多重割込み
### 割込み処理の入れ子
### 同時割込み



### PC(Program Counter)

### PS() : ステータスレジスタ





### REFERENCE
ルネサス
https://www.renesas.com/jp/ja/support/engineer-school/mcu-programming-peripherals-04-interrupts

https://www.renesas.com/us/ja/document/man/897151


メインフレームコンピュータ
http://www.arteceed.net/6.html
https://arteceed.info/


東芝デバイス＆ストレージ_e-ラーニング
https://toshiba.semicon-storage.com/jp/semiconductor/knowledge/e-learning.html

割り込みハードウェアメカニズム
https://www.comp.tmu.ac.jp/morbier/work/interrupthwmec.pdf
